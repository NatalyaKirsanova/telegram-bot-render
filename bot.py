import os
import requests
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes

# –¢–æ–∫–µ–Ω—ã
BOT_TOKEN = os.environ.get('BOT_TOKEN')
OZON_API_KEY = os.environ.get('OZON_API_KEY')
OZON_CLIENT_ID = os.environ.get('OZON_CLIENT_ID')

# –ö—ç—à —Ç–æ–≤–∞—Ä–æ–≤
products_cache = {}
user_carts = {}
user_orders = {}
current_product_index = {}

class OzonSellerAPI:
    def __init__(self):
        self.headers = {
            "Client-Id": OZON_CLIENT_ID,
            "Api-Key": OZON_API_KEY,
            "Content-Type": "application/json"
        }
    
    def test_all_endpoints(self):
        """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ endpoints Ozon API"""
        endpoints = [
            {
                "name": "v2/product/list",
                "url": "https://api-seller.ozon.ru/v2/product/list",
                "payload": {"filter": {"visibility": "ALL"}, "limit": 5}
            },
            {
                "name": "v3/product/list", 
                "url": "https://api-seller.ozon.ru/v3/product/list",
                "payload": {"filter": {}, "limit": 5}
            },
            {
                "name": "v3/product/info/attributes",
                "url": "https://api-seller.ozon.ru/v3/product/info/attributes", 
                "payload": {"filter": {}, "limit": 5}
            },
            {
                "name": "v2/category/tree",
                "url": "https://api-seller.ozon.ru/v2/category/tree",
                "payload": {}
            },
            {
                "name": "v1/category/tree", 
                "url": "https://api-seller.ozon.ru/v1/category/tree",
                "payload": {}
            }
        ]
        
        print("üîç –¢–µ—Å—Ç–∏—Ä—É–µ–º endpoints Ozon API...")
        working_endpoints = []
        
        for endpoint in endpoints:
            try:
                response = requests.post(
                    endpoint["url"],
                    headers=self.headers,
                    json=endpoint["payload"],
                    timeout=10
                )
                status = "‚úÖ –†–ê–ë–û–¢–ê–ï–¢" if response.status_code == 200 else f"‚ùå {response.status_code}"
                print(f"   {endpoint['name']}: {status}")
                
                if response.status_code == 200:
                    working_endpoints.append(endpoint)
                    
            except Exception as e:
                print(f"   {endpoint['name']}: ‚ùå –û—à–∏–±–∫–∞ {e}")
        
        return working_endpoints
    
    def get_products_working(self, limit=20):
        """–ü–æ–ª—É—á–∞–µ—Ç —Ç–æ–≤–∞—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—è —Ä–∞–±–æ—á–∏–µ endpoints"""
        working_endpoints = self.test_all_endpoints()
        
        if not working_endpoints:
            print("‚ùå –ù–µ—Ç —Ä–∞–±–æ—á–∏—Ö endpoints Ozon API")
            return None
        
        # –ü—Ä–æ–±—É–µ–º –ø–µ—Ä–≤—ã–π —Ä–∞–±–æ—á–∏–π endpoint
        endpoint = working_endpoints[0]
        print(f"üîÑ –ò—Å–ø–æ–ª—å–∑—É–µ–º endpoint: {endpoint['name']}")
        
        try:
            response = requests.post(
                endpoint["url"],
                headers=self.headers,
                json={**endpoint["payload"], "limit": limit},
                timeout=10
            )
            
            if response.status_code == 200:
                return response.json()
            else:
                print(f"‚ùå –û—à–∏–±–∫–∞ {endpoint['name']}: {response.status_code}")
                return None
                
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ {endpoint['name']}: {e}")
            return None

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è API
ozon_api = OzonSellerAPI()

async def load_real_products():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ Ozon API"""
    global products_cache
    
    print("üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ Ozon...")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ API –∫–ª—é—á–µ–π
    if not OZON_CLIENT_ID or not OZON_API_KEY:
        print("‚ùå API –∫–ª—é—á–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã!")
        products_cache = {}
        return {}
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–≤–∞—Ä—ã —á–µ—Ä–µ–∑ —Ä–∞–±–æ—á–∏–µ endpoints
    products_data = ozon_api.get_products_working(limit=20)
    
    if not products_data:
        print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–≤–∞—Ä—ã —á–µ—Ä–µ–∑ Ozon API")
        
        # –°–æ–∑–¥–∞–µ–º –¥–µ–º–æ-—Ç–æ–≤–∞—Ä—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞
        print("‚ö†Ô∏è –°–æ–∑–¥–∞–µ–º –¥–µ–º–æ-—Ç–æ–≤–∞—Ä—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...")
        demo_products = create_demo_products()
        products_cache = demo_products
        return demo_products
    
    products = {}
    product_counter = 1
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–≤–∞—Ä—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç–≤–µ—Ç–∞
    try:
        # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç–≤–µ—Ç–∞ Ozon API
        items = []
        
        if 'result' in products_data and 'items' in products_data['result']:
            items = products_data['result']['items']
        elif 'items' in products_data:
            items = products_data['items']
        elif 'products' in products_data:
            items = products_data['products']
        else:
            # –ï—Å–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–µ—Å—å –æ—Ç–≤–µ—Ç –∫–∞–∫ —Å–ø–∏—Å–æ–∫
            items = [products_data]
        
        for item in items:
            try:
                # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏—è –∏ ID
                name = item.get('name') or item.get('title') or item.get('product_name') or f'–¢–æ–≤–∞—Ä {product_counter}'
                product_id = item.get('id') or item.get('product_id') or item.get('offer_id') or str(product_counter)
                offer_id = item.get('offer_id') or item.get('sku') or str(product_counter)
                
                # –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—É (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)
                price = item.get('price') or item.get('current_price') or 1999
                
                products[product_counter] = {
                    'ozon_id': product_id,
                    'offer_id': offer_id,
                    'name': name,
                    'price': price,
                    'image': "üì¶",
                    'description': "–¢–æ–≤–∞—Ä –∏–∑ –Ω–∞—à–µ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞",
                    'quantity': item.get('quantity', 1) or item.get('stock', 1) or 1
                }
                
                product_counter += 1
                
            except Exception as e:
                print(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–æ–≤–∞—Ä–∞: {e}")
                continue
                
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ –æ—Ç–≤–µ—Ç–∞ Ozon API: {e}")
        # –°–æ–∑–¥–∞–µ–º –¥–µ–º–æ-—Ç–æ–≤–∞—Ä—ã –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å –æ—Ç–≤–µ—Ç
        demo_products = create_demo_products()
        products_cache = demo_products
        return demo_products
    
    print(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(products)} —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ Ozon")
    products_cache = products
    return products

def create_demo_products():
    """–°–æ–∑–¥–∞–µ—Ç –¥–µ–º–æ-—Ç–æ–≤–∞—Ä—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
    return {
        1: {"name": "–°–º–∞—Ä—Ç—Ñ–æ–Ω Xiaomi", "price": 19999, "image": "üì±", "description": "–°–º–∞—Ä—Ç—Ñ–æ–Ω —Å –æ—Ç–ª–∏—á–Ω–æ–π –∫–∞–º–µ—Ä–æ–π", "quantity": 10},
        2: {"name": "–ù–∞—É—à–Ω–∏–∫–∏ Sony", "price": 12999, "image": "üéß", "description": "–ë–µ—Å–ø—Ä–æ–≤–æ–¥–Ω—ã–µ –Ω–∞—É—à–Ω–∏–∫–∏", "quantity": 15},
        3: {"name": "–§—É—Ç–±–æ–ª–∫–∞ —Ö–ª–æ–ø–∫–æ–≤–∞—è", "price": 1499, "image": "üëï", "description": "–ú—É–∂—Å–∫–∞—è —Ñ—É—Ç–±–æ–ª–∫–∞", "quantity": 25},
        4: {"name": "–ö—Ä–æ—Å—Å–æ–≤–∫–∏ Nike", "price": 8999, "image": "üëü", "description": "–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ –∫—Ä–æ—Å—Å–æ–≤–∫–∏", "quantity": 8},
    }

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    user = update.message.from_user
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    if not products_cache:
        await load_real_products()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Ç–æ–≤–∞—Ä—ã
    if not products_cache:
        keyboard = [
            [InlineKeyboardButton("üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞", callback_data="refresh_products")],
            [InlineKeyboardButton("üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞", callback_data="support")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await update.message.reply_text(
            "‚ùå *–¢–æ–≤–∞—Ä—ã –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã*\n\n"
            "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä—ã –∏–∑ –º–∞–≥–∞–∑–∏–Ω–∞.\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.",
            reply_markup=reply_markup,
            parse_mode='Markdown'
        )
        return
    
    keyboard = [
        [InlineKeyboardButton("üõçÔ∏è –°–º–æ—Ç—Ä–µ—Ç—å —Ç–æ–≤–∞—Ä—ã", callback_data="view_products")],
        [InlineKeyboardButton("üõí –ú–æ—è –∫–æ—Ä–∑–∏–Ω–∞", callback_data="cart")],
        [InlineKeyboardButton("üì¶ –ú–æ–∏ –∑–∞–∫–∞–∑—ã", callback_data="my_orders")],
        [InlineKeyboardButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä—ã", callback_data="refresh_products")],
        [InlineKeyboardButton("üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞", callback_data="support")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    welcome_text = (
        f"üëã –ü—Ä–∏–≤–µ—Ç, {user.first_name}!\n\n"
        "üè™ *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à Ozon –º–∞–≥–∞–∑–∏–Ω!*\n\n"
        f"üì¶ *–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤:* {len(products_cache)}\n"
        "üõí –î–µ–ª–∞–π—Ç–µ –∑–∞–∫–∞–∑—ã –ø—Ä—è–º–æ –≤ Telegram!\n\n"
        "–ù–∞–∂–º–∏—Ç–µ '–°–º–æ—Ç—Ä–µ—Ç—å —Ç–æ–≤–∞—Ä—ã' —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø–æ–∫—É–ø–∫–∏:"
    )
    
    await update.message.reply_text(welcome_text, reply_markup=reply_markup, parse_mode='Markdown')

# ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (view_products, show_product, add_to_cart –∏ —Ç.–¥.) –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    if not BOT_TOKEN:
        print("‚ùå BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return
    
    application = Application.builder().token(BOT_TOKEN).build()
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("refresh", refresh_products))
    application.add_handler(CallbackQueryHandler(handle_callback))
    
    # –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
    print("üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ Ozon...")
    
    print("üõçÔ∏è Ozon Client Bot –∑–∞–ø—É—â–µ–Ω!")
    application.run_polling()

if __name__ == '__main__':
    main()
